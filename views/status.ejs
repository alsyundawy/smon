<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Custom animations and styles */
    @keyframes pulse-green {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .animate-pulse-green {
      animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse-blue {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .animate-pulse-blue {
      animation: pulse-blue 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    /* Smooth transitions */
    * {
      transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 300ms;
    }

    /* Progress bar styles */
    .progress-bar {
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-bg {
      background: linear-gradient(90deg, #374151 0%, #4b5563 100%);
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-gray-100 min-h-screen">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="max-w-6xl w-full space-y-8">
      <!-- Header Card -->
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-8 shadow-2xl animate-fade-in">
        <div class="text-center">
          <!-- Logo and Title Section -->
          <div class="flex items-center justify-center gap-6 mb-6">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-2xl">
              <i class="fas fa-chart-line text-white text-3xl"></i>
            </div>
            <div class="text-left">
              <h1 class="text-4xl font-bold text-white mb-2">SMon</h1>
              <p class="text-lg text-gray-400">Network Monitoring System</p>
              <div class="flex items-center gap-2 mt-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-sm text-green-400 font-medium">System Online</span>
              </div>
            </div>
          </div>

          <!-- Page Title and Description -->
          <div class="mb-8">
            <h2 class="text-2xl font-bold text-white mb-3">System Status Dashboard</h2>
            <p class="text-gray-400 max-w-2xl mx-auto leading-relaxed">
              Comprehensive overview of your network monitoring system health, device status, and service availability.
            </p>
          </div>

          <!-- Navigation -->
          <div class="flex justify-center">
            <a href="/" class="inline-flex items-center gap-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 group">
              <i class="fas fa-home group-hover:scale-110 transition-transform duration-200"></i>
              Back to Dashboard
            </a>
          </div>
        </div>
      </div>

      <!-- Status Cards Container -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="status-container">
        <!-- Loading placeholder -->
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-6 shadow-2xl animate-fade-in">
          <div class="flex items-center justify-center h-32">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-6 shadow-2xl animate-fade-in">
          <div class="flex items-center justify-center h-32">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-6 shadow-2xl animate-fade-in">
          <div class="flex items-center justify-center h-32">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
          </div>
        </div>
      </div>

      <!-- System Details -->
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-8 shadow-2xl animate-fade-in" id="system-details" style="display: none;">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-server text-white text-sm"></i>
          </div>
          System Details
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="system-info">
          <!-- Loading -->
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-orange-500 mx-auto mb-2"></div>
            <p class="text-gray-400">Loading system information...</p>
          </div>
        </div>
      </div>

      <!-- Device Status -->
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-8 shadow-2xl animate-fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-server text-white text-sm"></i>
          </div>
          Device Status
        </h2>
        <div id="device-status" class="space-y-4">
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mx-auto mb-2"></div>
            <p class="text-gray-400">Loading device status...</p>
          </div>
        </div>
      </div>

      <!-- Ping Status -->
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-8 shadow-2xl animate-fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-broadcast-tower text-white text-sm"></i>
          </div>
          Ping Status
        </h2>
        <div id="ping-status" class="space-y-4">
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500 mx-auto mb-2"></div>
            <p class="text-gray-400">Loading ping status...</p>
          </div>
        </div>
      </div>

      <!-- Website Status -->
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-8 shadow-2xl animate-fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-globe text-white text-sm"></i>
          </div>
          Website Status
        </h2>
        <div id="website-status" class="space-y-4">
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-cyan-500 mx-auto mb-2"></div>
            <p class="text-gray-400">Loading website status...</p>
          </div>
        </div>
      </div>

      <!-- Domain Status -->
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-8 shadow-2xl animate-fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-at text-white text-sm"></i>
          </div>
          Domain Status
        </h2>
        <div id="domain-status" class="space-y-4">
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-orange-500 mx-auto mb-2"></div>
            <p class="text-gray-400">Loading domain status...</p>
          </div>
        </div>
      </div>

      <!-- History Status -->
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-8 shadow-2xl animate-fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-history text-white text-sm"></i>
          </div>
          Recent History
        </h2>
        <div id="history-status" class="space-y-4">
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500 mx-auto mb-2"></div>
            <p class="text-gray-400">Loading recent history...</p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center text-gray-500 text-sm animate-fade-in">
        <p>Â© 2025 SMon - Network Monitoring System</p>
        <p class="mt-1">Last updated: <span id="last-updated">Loading...</span></p>
      </div>
    </div>
  </div>

  <script>
    // Status data
    let statusData = {
      snmp: { status: 'unknown', message: 'Checking...' },
      ping: { status: 'unknown', message: 'Checking...' },
      website: { status: 'unknown', message: 'Checking...' },
      database: { status: 'unknown', message: 'Checking...' },
      telegram: { status: 'unknown', message: 'Checking...' }
    };
    let pollingIntervalMs = <%= pollingIntervalSeconds * 1000 %>; // Auto-refresh interval from settings

    // Update status cards
    function updateStatusCards() {
      const container = document.getElementById('status-container');

      const cards = [
        {
          title: 'SNMP Monitoring',
          icon: 'fas fa-network-wired',
          color: 'blue',
          key: 'snmp'
        },
        {
          title: 'Ping Monitoring',
          icon: 'fas fa-broadcast-tower',
          color: 'green',
          key: 'ping'
        },
        {
          title: 'Website Monitoring',
          icon: 'fas fa-globe',
          color: 'cyan',
          key: 'website'
        },
        {
          title: 'Database',
          icon: 'fas fa-database',
          color: 'purple',
          key: 'database'
        },
        {
          title: 'Telegram Bot',
          icon: 'fab fa-telegram-plane',
          color: 'blue',
          key: 'telegram'
        },
        {
          title: 'Web Interface',
          icon: 'fas fa-globe',
          color: 'green',
          key: 'web'
        },
        {
          title: 'System Health',
          icon: 'fas fa-heartbeat',
          color: 'red',
          key: 'system'
        }
      ];

      container.innerHTML = cards.map(card => {
        const data = statusData[card.key] || { status: 'unknown', message: 'Checking...' };
        const statusColor = getStatusColor(data.status);
        const pulseClass = data.status === 'online' ? 'animate-pulse-green' : data.status === 'active' ? 'animate-pulse-blue' : '';

        return `
          <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-slate-700/50 p-6 shadow-2xl hover:shadow-3xl transition-all duration-300 hover:scale-105 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-${card.color}-500 to-${card.color}-600 rounded-xl flex items-center justify-center shadow-lg ${pulseClass}">
                  <i class="${card.icon} text-white text-lg"></i>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-white">${card.title}</h3>
                  <p class="text-sm text-gray-400">${data.message}</p>
                </div>
              </div>
              <div class="w-4 h-4 bg-${statusColor}-500 rounded-full shadow-lg ${data.status === 'online' || data.status === 'active' ? 'animate-pulse' : ''}"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getStatusColor(status) {
      switch(status) {
        case 'online':
        case 'active':
        case 'healthy':
          return 'green';
        case 'warning':
          return 'yellow';
        case 'error':
        case 'offline':
          return 'red';
        default:
          return 'gray';
      }
    }

    // Update system information
    async function updateSystemInfo() {
      try {
        const response = await fetch('/api/system-info');
        const data = await response.json();

        document.getElementById('system-details').style.display = 'block';

        const systemInfo = document.getElementById('system-info');
        systemInfo.innerHTML = `
          <div class="space-y-4">
            <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
              <span class="text-gray-300">Node.js Version</span>
              <span class="text-white font-medium">${data.nodeVersion}</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
              <span class="text-gray-300">Platform</span>
              <span class="text-white font-medium">${data.platform}</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
              <span class="text-gray-300">Uptime</span>
              <span class="text-white font-medium">${data.uptime}</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
              <span class="text-gray-300">CPU Cores</span>
              <span class="text-white font-medium">${data.cpuCores}</span>
            </div>
          </div>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between items-center mb-2">
                <span class="text-gray-300">CPU Usage</span>
                <span class="text-white font-medium">${data.cpuUsage}%</span>
              </div>
              <div class="progress-bg w-full h-3">
                <div class="progress-bar h-3" style="width: ${Math.min(data.cpuUsage, 100)}%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between items-center mb-2">
                <span class="text-gray-300">Memory Usage</span>
                <span class="text-white font-medium">${Math.round((data.memory.used / data.memory.total) * 100)}%</span>
              </div>
              <div class="progress-bg w-full h-3">
                <div class="progress-bar h-3" style="width: ${Math.min((data.memory.used / data.memory.total) * 100, 100)}%"></div>
              </div>
              <div class="text-xs text-gray-400 mt-1">
                ${Math.round(data.memory.used / 1024 / 1024 / 1024 * 10) / 10}GB / ${Math.round(data.memory.total / 1024 / 1024 / 1024 * 10) / 10}GB
              </div>
            </div>
            ${data.storage && data.storage.total > 0 ? `
            <div>
              <div class="flex justify-between items-center mb-2">
                <span class="text-gray-300">Storage Usage</span>
                <span class="text-white font-medium">${data.storage.percent}%</span>
              </div>
              <div class="progress-bg w-full h-3">
                <div class="progress-bar h-3" style="width: ${Math.min(data.storage.percent, 100)}%"></div>
              </div>
              <div class="text-xs text-gray-400 mt-1">
                ${Math.round(data.storage.used / 1024 / 1024 / 1024 * 10) / 10}GB / ${Math.round(data.storage.total / 1024 / 1024 / 1024 * 10) / 10}GB
              </div>
            </div>
            ` : ''}
          </div>
        `;
      } catch (error) {
        console.error('Error fetching system info:', error);
        document.getElementById('system-info').innerHTML = `
          <div class="text-center py-8 text-red-400">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Unable to load system information</p>
          </div>
        `;
      }
    }

    // Check service statuses
    async function checkStatuses() {
      try {
        // Check database connectivity
        const dbResponse = await fetch('/api/settings/influxdb/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        }).catch(() => ({ ok: false }));

        statusData.database = dbResponse.ok ?
          { status: 'online', message: 'Connected' } :
          { status: 'offline', message: 'Connection failed' };

        // Check web interface
        statusData.web = { status: 'online', message: 'Running' };

        // Check system health
        const systemResponse = await fetch('/api/system-info');
        const systemData = await systemResponse.json();
        const cpuUsage = systemData.cpuUsage || 0;
        const memoryUsage = (systemData.memory.used / systemData.memory.total) * 100;

        if (cpuUsage > 90 || memoryUsage > 90) {
          statusData.system = { status: 'warning', message: 'High resource usage' };
        } else if (cpuUsage > 70 || memoryUsage > 80) {
          statusData.system = { status: 'warning', message: 'Moderate load' };
        } else {
          statusData.system = { status: 'healthy', message: 'Normal operation' };
        }

        // SNMP and Ping status (we'll assume they're active if the app is running)
        statusData.snmp = { status: 'active', message: 'Monitoring active' };
        statusData.ping = { status: 'active', message: 'Monitoring active' };
        statusData.website = { status: 'active', message: 'Monitoring active' };

        // Telegram status (we can't easily check this without authentication)
        statusData.telegram = { status: 'unknown', message: 'Status unknown' };

      } catch (error) {
        console.error('Error checking statuses:', error);
      }

      updateStatusCards();
    }

    // Update timestamp
    function updateTimestamp() {
      const now = new Date();
      document.getElementById('last-updated').textContent = now.toLocaleString('id-ID');
    }

    // Load device status
    async function loadDeviceStatus() {
      try {
        const response = await fetch('/api/devices');
        const devicesObj = await response.json();
        const devices = Object.values(devicesObj); // Convert object to array

        const deviceContainer = document.getElementById('device-status');
        if (devices.length === 0) {
          deviceContainer.innerHTML = `
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-server text-3xl mb-2"></i>
              <p>No devices configured</p>
            </div>
          `;
          return;
        }

        deviceContainer.innerHTML = devices.map(device => {
          const statusColor = device.enabled ? 'green' : 'gray';
          const statusText = device.enabled ? 'Enabled' : 'Disabled';
          const statusIcon = device.enabled ? 'check-circle' : 'times-circle';

          return `
            <div class="flex items-center justify-between p-4 bg-slate-700/30 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-${statusColor}-500 rounded-full"></div>
                <div>
                  <p class="text-white font-medium">${device.name}</p>
                  <p class="text-gray-400 text-sm">${device.host}</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-${statusIcon} text-${statusColor}-400"></i>
                <span class="text-${statusColor}-400 text-sm">${statusText}</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading device status:', error);
        document.getElementById('device-status').innerHTML = `
          <div class="text-center py-8 text-red-400">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Unable to load device status</p>
          </div>
        `;
      }
    }

    // Load ping status
    async function loadPingStatus() {
      try {
        const response = await fetch('/api/ping-targets');
        const targets = await response.json();

        const pingContainer = document.getElementById('ping-status');
        if (targets.length === 0) {
          pingContainer.innerHTML = `
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-broadcast-tower text-3xl mb-2"></i>
              <p>No ping targets configured</p>
            </div>
          `;
          return;
        }

        // Load latest status for each target
        const statusPromises = targets.map(async (target) => {
          try {
            const historyResponse = await fetch(`/api/ping-history/${target.id}`);
            const historyData = await historyResponse.json();
            
            if (historyData.data && historyData.data.length > 0) {
              const latest = historyData.data[historyData.data.length - 1];
              return { ...target, latest };
            }
            return { ...target, latest: null };
          } catch (error) {
            return { ...target, latest: null };
          }
        });

        const targetsWithStatus = await Promise.all(statusPromises);

        pingContainer.innerHTML = targetsWithStatus.map(target => {
          const isEnabled = target.enabled;
          const hasData = target.latest;
          const isAlive = hasData ? target.latest.alive : false;
          
          let statusColor, statusText, statusIcon;
          
          if (!isEnabled) {
            statusColor = 'gray';
            statusText = 'Disabled';
            statusIcon = 'times-circle';
          } else if (!hasData) {
            statusColor = 'yellow';
            statusText = 'No Data';
            statusIcon = 'question-circle';
          } else if (isAlive) {
            statusColor = 'green';
            statusText = `${target.latest.time}ms`;
            statusIcon = 'check-circle';
          } else {
            statusColor = 'red';
            statusText = 'Down';
            statusIcon = 'times-circle';
          }

          return `
            <div class="flex items-center justify-between p-4 bg-slate-700/30 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-${statusColor}-500 rounded-full"></div>
                <div>
                  <p class="text-white font-medium">${target.name}</p>
                  <p class="text-gray-400 text-sm">${target.host}</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-${statusIcon} text-${statusColor}-400"></i>
                <span class="text-${statusColor}-400 text-sm">${statusText}</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading ping status:', error);
        document.getElementById('ping-status').innerHTML = `
          <div class="text-center py-8 text-red-400">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Unable to load ping status</p>
          </div>
        `;
      }
    }

    // Load website status
    async function loadWebsiteStatus() {
      try {
        const response = await fetch('/api/website-targets');
        const targets = await response.json();

        const websiteContainer = document.getElementById('website-status');
        if (targets.length === 0) {
          websiteContainer.innerHTML = `
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-globe text-3xl mb-2"></i>
              <p>No website targets configured</p>
            </div>
          `;
          return;
        }

        // Load latest status for each target
        const statusPromises = targets.map(async (target) => {
          try {
            const historyResponse = await fetch(`/api/website-history/${target.id}`);
            const historyData = await historyResponse.json();
            
            if (historyData.data && historyData.data.length > 0) {
              const latest = historyData.data[historyData.data.length - 1];
              return { ...target, latest };
            }
            return { ...target, latest: null };
          } catch (error) {
            return { ...target, latest: null };
          }
        });

        const targetsWithStatus = await Promise.all(statusPromises);

        websiteContainer.innerHTML = targetsWithStatus.map(target => {
          const isEnabled = target.enabled;
          const hasData = target.latest;
          const isUp = hasData ? target.latest.up : false;
          const responseTime = hasData ? target.latest.response_time : 0;
          const sslValid = hasData ? target.latest.ssl_valid : false;
          
          let statusColor, statusText, statusIcon;
          
          if (!isEnabled) {
            statusColor = 'gray';
            statusText = 'Disabled';
            statusIcon = 'times-circle';
          } else if (!hasData) {
            statusColor = 'yellow';
            statusText = 'No Data';
            statusIcon = 'question-circle';
          } else if (isUp) {
            statusColor = 'green';
            statusText = `${responseTime}ms`;
            statusIcon = 'check-circle';
          } else {
            statusColor = 'red';
            statusText = 'Down';
            statusIcon = 'times-circle';
          }

          const sslIcon = sslValid ? 'fas fa-shield-alt text-green-400' : 'fas fa-shield-alt text-red-400';
          const sslText = sslValid ? 'SSL Valid' : 'SSL Invalid';

          return `
            <div class="flex items-center justify-between p-4 bg-slate-700/30 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-${statusColor}-500 rounded-full"></div>
                <div>
                  <p class="text-white font-medium">${target.name}</p>
                  <p class="text-gray-400 text-sm">${target.url}</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-1">
                  <i class="${sslIcon} text-sm"></i>
                  <span class="text-xs ${sslValid ? 'text-green-400' : 'text-red-400'}">${sslText}</span>
                </div>
                <div class="flex items-center gap-2">
                  <i class="fas fa-${statusIcon} text-${statusColor}-400"></i>
                  <span class="text-${statusColor}-400 text-sm">${statusText}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading website status:', error);
        document.getElementById('website-status').innerHTML = `
          <div class="text-center py-8 text-red-400">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Unable to load website status</p>
          </div>
        `;
      }
    }

    // Load history status
    async function loadHistoryStatus() {
      try {
        const historyContainer = document.getElementById('history-status');
        
        // Get recent events from different sources
        const events = [];
        
        // Get recent ping events
        try {
          const pingResponse = await fetch('/api/ping-targets');
          const pingTargets = await pingResponse.json();
          
          for (const target of pingTargets.slice(0, 3)) { // Limit to 3 targets
            try {
              const historyResponse = await fetch(`/api/ping-history/${target.id}`);
              const historyData = await historyResponse.json();
              
              if (historyData.data && historyData.data.length > 0) {
                const latest = historyData.data[historyData.data.length - 1];
                events.push({
                  type: 'ping',
                  name: target.name,
                  status: latest.alive ? 'up' : 'down',
                  time: new Date(latest.time),
                  message: `${target.name} is ${latest.alive ? 'up' : 'down'} (${latest.time}ms)`
                });
              }
            } catch (e) {}
          }
        } catch (e) {}
        
        // Get recent website events
        try {
          const websiteResponse = await fetch('/api/website-targets');
          const websiteTargets = await websiteResponse.json();
          
          for (const target of websiteTargets.slice(0, 3)) { // Limit to 3 targets
            try {
              const historyResponse = await fetch(`/api/website-history/${target.id}`);
              const historyData = await historyResponse.json();
              
              if (historyData.data && historyData.data.length > 0) {
                const latest = historyData.data[historyData.data.length - 1];
                events.push({
                  type: 'website',
                  name: target.name,
                  status: latest.up ? 'up' : 'down',
                  time: new Date(latest.time),
                  message: `${target.name} is ${latest.up ? 'up' : 'down'} (${latest.response_time}ms)`
                });
              }
            } catch (e) {}
          }
        } catch (e) {}
        
        // Sort by time (most recent first) and limit to 10 events
        events.sort((a, b) => b.time - a.time);
        const recentEvents = events.slice(0, 10);
        
        if (recentEvents.length === 0) {
          historyContainer.innerHTML = `
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-history text-3xl mb-2"></i>
              <p>No recent events</p>
            </div>
          `;
          return;
        }
        
        historyContainer.innerHTML = recentEvents.map(event => {
          const timeAgo = getTimeAgo(event.time);
          const statusColor = event.status === 'up' ? 'green' : 'red';
          const typeIcon = event.type === 'ping' ? 'fas fa-broadcast-tower' : 'fas fa-globe';
          
          return `
            <div class="flex items-center justify-between p-4 bg-slate-700/30 rounded-lg">
              <div class="flex items-center gap-3">
                <i class="${typeIcon} text-${statusColor}-400"></i>
                <div>
                  <p class="text-white text-sm">${event.message}</p>
                  <p class="text-gray-400 text-xs">${timeAgo}</p>
                </div>
              </div>
              <div class="w-2 h-2 bg-${statusColor}-500 rounded-full"></div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading history status:', error);
        document.getElementById('history-status').innerHTML = `
          <div class="text-center py-8 text-red-400">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Unable to load history status</p>
          </div>
        `;
      }
    }

    // Load domain status
    async function loadDomainStatus() {
      try {
        const response = await fetch('/api/domain-targets');
        const domains = await response.json();

        const domainContainer = document.getElementById('domain-status');
        if (domains.length === 0) {
          domainContainer.innerHTML = `
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-at text-3xl mb-2"></i>
              <p>No domains configured</p>
            </div>
          `;
          return;
        }

        domainContainer.innerHTML = domains.map(domain => {
          const daysLeft = Math.ceil((new Date(domain.expiration_date) - new Date()) / (1000 * 60 * 60 * 24));
          const isExpiringSoon = daysLeft <= 30;
          const isExpired = daysLeft < 0;

          let statusColor, statusText, statusIcon;

          if (isExpired) {
            statusColor = 'red';
            statusText = 'Expired';
            statusIcon = 'exclamation-triangle';
          } else if (isExpiringSoon) {
            statusColor = 'yellow';
            statusText = `${daysLeft} days`;
            statusIcon = 'clock';
          } else {
            statusColor = 'green';
            statusText = `${daysLeft} days`;
            statusIcon = 'check-circle';
          }

          return `
            <div class="flex items-center justify-between p-4 bg-slate-700/30 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-${statusColor}-500 rounded-full"></div>
                <div>
                  <p class="text-white font-medium">${domain.name}</p>
                  <p class="text-gray-400 text-sm">${domain.registrar || 'Unknown Registrar'}</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-${statusIcon} text-${statusColor}-400"></i>
                <span class="text-${statusColor}-400 text-sm">${statusText}</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading domain status:', error);
        document.getElementById('domain-status').innerHTML = `
          <div class="text-center py-8 text-red-400">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Unable to load domain status</p>
          </div>
        `;
      }
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      return `${diffDays}d ago`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      updateStatusCards();
      updateSystemInfo();
      checkStatuses();
      updateTimestamp();
      loadDeviceStatus();
      loadPingStatus();
      loadWebsiteStatus();
      loadDomainStatus();
      loadHistoryStatus();

      // Update based on configured polling interval
      setInterval(() => {
        updateSystemInfo();
        checkStatuses();
        updateTimestamp();
        loadDeviceStatus();
        loadPingStatus();
        loadWebsiteStatus();
        loadDomainStatus();
        loadHistoryStatus();
      }, pollingIntervalMs);
    });
  </script>
</body>
</html>